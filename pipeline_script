pipeline {
    agent any

    environment {
        KUBE_CONFIG = '/root/.kube/config' 
        //KUBE_NAMESPACE = 'production' 
        KUBE_NAMESPACE = 'default'
        DEPLOYMENT_YAML = '/var/lib/jenkins/workspace/mynodepipeline'
        REMOTE_HOST = '172.31.34.233'
        REMOTE_USER = 'ec2-user' 
		DOCKER_REGISTRY = "devopsadmin786"
        DOCKER_IMAGE_NAME = "mynodeapp"
        DOCKER_IMAGE_TAG = "latest"
        BUILD_ID = "${env.BUILD_ID}"
        DOCKER_HUB_CREDENTIALS = 'dockerhublogin'
        SERVICE_FILE = "service.yaml"
		SERVER_PATH = '/home/ec2-user'
    }

    stages {
	
		stage('Git Checkout') {
            steps {
                git branch: 'main', credentialsId: 'GitLogins', url: 'https://github.com/DevopsAdmin786/nodejs-docker.git'
            }
		}
        stage('Build Docker Image') {
            steps {
                script {
					docker.build("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:v1.${BUILD_ID}")
                    docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:v1.${BUILD_ID}").tag("${DOCKER_IMAGE_TAG}")
                }
            }
        }
        stage('Push Docker Image') {
            steps {
                script {
					docker.withRegistry('https://registry.hub.docker.com', DOCKER_HUB_CREDENTIALS) {
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}").push('latest')
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}").push("v1.${BUILD_ID}")
                    }
                }
            }
        }
		stage ('Remove Docker Image from Jenkins Server') {
            steps {
                script {
                    sh "docker images -q | xargs docker image rm -f"
                }
            }
        }
        stage('Deploy to Remote Kubernetes Server') {
            steps {
                script {
                    sshagent(['kubernetserver']) {
                         // Copy Deployment.yaml to remote Kubernetes server
                        sh "scp -o StrictHostKeyChecking=no ${DEPLOYMENT_YAML}/*.yaml ${REMOTE_USER}@${REMOTE_HOST}:${SERVER_PATH}"
                        // Update Kubernetes deployment with the new Docker image on the remote server
                       // sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} sudo kubectl --kubeconfig=${KUBE_CONFIG} --namespace=${KUBE_NAMESPACE} set image -f ${SERVER_PATH}/Deployment.yaml ${DOCKER_IMAGE_NAME}=${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
                        sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} sudo kubectl --kubeconfig=${KUBE_CONFIG} --namespace=${KUBE_NAMESPACE} set image -f ${SERVER_PATH}/Deployment.yaml ${DOCKER_IMAGE_NAME}=${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:v1.${BUILD_ID}"
                    }
                }
            }
        }
	}
}
